<!DOCTYPE html>
<html>
  <head>
    <title>แผนที่ควบคุมมลพิษแบบโต้ตอบ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: sans-serif;
      }
      #map {
        height: calc(100vh - 180px);
        width: 100%;
      }
      #controls {
        padding: 10px;
        background: #f0f0f0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      input, button, label, select {
        padding: 5px;
        font-size: 16px;
      }
      input[type="number"] {
        width: 100px;
      }
      #communitySelect {
        min-width: 200px;
        height: 80px;
      }
      .gm-style .community-label {
        text-shadow: 1px 1px 2px #000;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <label for="radiusInput">รัศมี (เมตร):</label>
      <input type="number" id="radiusInput" value="1000" min="100" step="100">
      <label for="colorInput">สี:</label>
      <input type="color" id="colorInput" value="#FF0000">
      <label><input type="checkbox" id="fillToggle" checked> เติมสีด้านใน</label>
      <button onclick="undoLast()">Undo</button>
      <button onclick="clearMap()">ล้างแผนที่</button>
      <label>ละติจูด:</label>
      <input type="number" id="latInput" step="0.000001" placeholder="เช่น 12.738">
      <label>ลองจิจูด:</label>
      <input type="number" id="lngInput" step="0.000001" placeholder="เช่น 101.185">
      <button onclick="addPointFromInput()">ลงจุดจากพิกัด</button>
      <label for="communitySelect">เลือกชุมชน:</label>
      <select id="communitySelect" multiple onchange="showSelectedCommunities()"></select>
    </div>

    <div id="map"></div>

    <script>
      let map;
      let circles = [];
      let markers = [];
      let communityFeatures = {};
      let labelMarkers = {};

      function drawCircle(latLng) {
        const radius = parseInt(document.getElementById("radiusInput").value) || 1000;
        const color = document.getElementById("colorInput").value;
        const fillOpacity = document.getElementById("fillToggle").checked ? 0.35 : 0;

        const circle = new google.maps.Circle({
          strokeColor: color,
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: color,
          fillOpacity: fillOpacity,
          map,
          center: latLng,
          radius: radius,
          clickable: false
        });
        circles.push(circle);

        const marker = new google.maps.Marker({
          position: latLng,
          map: map,
        });
        markers.push(marker);
      }

      function addPointFromInput() {
        const lat = parseFloat(document.getElementById("latInput").value);
        const lng = parseFloat(document.getElementById("lngInput").value);
        if (!isNaN(lat) && !isNaN(lng)) {
          drawCircle(new google.maps.LatLng(lat, lng));
        } else {
          alert("กรุณากรอกพิกัดให้ถูกต้อง");
        }
      }

      function getPolygonCentroid(path) {
        let area = 0, x = 0, y = 0;
        const len = path.getLength();
        for (let i = 0; i < len; i++) {
          const p1 = path.getAt(i);
          const p2 = path.getAt((i + 1) % len);
          const f = p1.lat() * p2.lng() - p2.lat() * p1.lng();
          area += f;
          x += (p1.lat() + p2.lat()) * f;
          y += (p1.lng() + p2.lng()) * f;
        }
        area *= 0.5;
        x /= (6 * area);
        y /= (6 * area);
        return new google.maps.LatLng(x, y);
      }

      function showSelectedCommunities() {
        const select = document.getElementById("communitySelect");
        const selected = Array.from(select.selectedOptions).map(opt => opt.value);

        selected.forEach(name => {
          if (labelMarkers[name]) return;

          const feature = communityFeatures[name];
          if (!feature) return;

          const geometry = feature.getGeometry();
          let center;

          if (geometry.getType() === 'Polygon') {
            center = getPolygonCentroid(geometry.getAt(0));
          } else if (geometry.getType() === 'MultiPolygon') {
            center = getPolygonCentroid(geometry.getAt(0).getAt(0));
          }

          if (center) {
            const labelMarker = new google.maps.Marker({
              position: center,
              map: map,
              label: {
                text: name,
                fontSize: "14px",
                fontWeight: "bold",
                color: "#FFFFFF",
                className: "community-label"
              },
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 0
              }
            });
            labelMarkers[name] = labelMarker;
          }
        });
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 12.738, lng: 101.185 },
          zoom: 12,
          styles: [
            { featureType: "poi", stylers: [{ visibility: "off" }] },
            { featureType: "transit", stylers: [{ visibility: "off" }] },
            { featureType: "road", elementType: "labels", stylers: [{ visibility: "off" }] },
            { featureType: "administrative", elementType: "labels", stylers: [{ visibility: "off" }] }
          ]
        });

        map.data.loadGeoJson('ผังโครงร่างเขตควบคุมมลพิษ.json');

        map.data.setStyle(feature => ({
          fillColor: feature.getProperty('fill') || '#FF0000',
          fillOpacity: feature.getProperty('fill-opacity') || 0.3,
          strokeColor: feature.getProperty('stroke') || '#FF0000',
          strokeWeight: feature.getProperty('stroke-width') || 2
        }));

        map.data.addListener("addfeature", function(event) {
          const feature = event.feature;
          const name = feature.getProperty("name");
          if (name) {
            communityFeatures[name] = feature;
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            document.getElementById("communitySelect").appendChild(option);
          }
        });

        map.data.addListener("click", (event) => {
          if (event.latLng) {
            drawCircle(event.latLng);
          }
        });

        map.addListener("click", (e) => {
          drawCircle(e.latLng);
        });
      }

      function clearMap() {
        circles.forEach(c => c.setMap(null));
        markers.forEach(m => m.setMap(null));
        Object.values(labelMarkers).forEach(m => m.setMap(null));
        circles = [];
        markers = [];
        labelMarkers = {};
      }

      function undoLast() {
        if (circles.length > 0) {
          circles.pop().setMap(null);
          markers.pop().setMap(null);
        }
      }
    </script>

    <script async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDuVjbyua3vpKU_05o6KSc3zUh7iMYVo4c&callback=initMap">
    </script>
  </body>
</html>
